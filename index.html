<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGDCC</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8HJ2W33ZXE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-8HJ2W33ZXE');
    </script>
</head>

<body>
    <div class="container">
        <h1 style="margin-top: 5px;">IGDCC <sub class="adicione" title="adicione">REV2</sub></h1>
        <form id="calcForm">
            <div class="input-group">
                <!-- <label>Tipo de entrada:</label> -->
                <div class="radio-group">
                    <input type="radio" id="tipoTempo" name="tipoEntrada" value="tempo" checked>
                    <label for="tipoTempo">Tempo total</label>
                    <input type="radio" id="tipoPace" name="tipoEntrada" value="pace">
                    <label for="tipoPace">Pace (min/km)</label>
                </div>
            </div>

            <div id="tempoInput">
                <label for="tempo">Tempo (mm:ss ou hh:mm:ss):</label>
                <input type="text" id="tempo" value="30:38">
            </div>

            <div id="paceInput" style="display: none;">
                <label for="pace">Pace (mm:ss):</label>
                <input type="text" id="pace" value="04:59">
            </div>

            <label for="idade">Idade:</label>
            <input type="number" id="idade" value="35" required>

            <label for="sexo">Sexo:</label>
            <select id="sexo" required>
                <option value="M">Masculino</option>
                <option value="F" selected>Feminino</option>
            </select>

            <label for="distancia">Dist√¢ncia (km):</label>
            <input type="number" id="distancia" step="0.01" value="5" required>

            <button type="submit">üßÆ Calcular Nota</button>
        </form>

        <div id="resultado">
            <div id="nota">
                <div class="share-card" id="shareCard" style="display: none;">
                    <div class="share-top" style="position: relative; text-align: center;margin-bottom: 2px;">
                        <img src="img/heraldica.png" alt="Heraldica" style="position: absolute; left: calc(50% - 48px); height: 30px; width: auto; top: 50%; transform: translateY(-60%);">
                        <div style="display: inline-block;">
                            <span class="main">IGDCC<span class="rev">REV2</span></span>
                            <div class="card-date" id="cardDate"
                                style="font-size:.7rem;font-weight:lighter;opacity:.8;margin-top:3px; margin-bottom: 5px">
                            </div>
                        </div>
                    </div>
                    <div class="score-big" id="scoreBig"></div>
                    <div id="scoreDistancia"
                        style="font-family: 'Inter', sans-serif; font-size: 2.7rem; font-weight: 800; text-align: center; width: 100%; line-height: 1; letter-spacing: -0.04em;">
                    </div>
                    <div class="zone-small" id="zoneSmall"></div>
                    <div class="card-meta"
                        style="display:flex;gap:12px;margin-top:8px;align-items:center;justify-content:center;">
                        <div class="meta-item" style="text-align:center">
                            <div style="font-size:.75rem;font-weight:700;opacity:.9">üïí Tempo</div>
                            <div style="font-size:.95rem;font-weight:800" id="cardTempo"></div>
                        </div>
                        <div class="meta-item" style="text-align:center">
                            <div style="font-size:.75rem;font-weight:700;opacity:.9">üèÉüèª‚Äç‚ôÇÔ∏è‚Äç‚û°Ô∏è Pace</div>
                            <div style="font-size:.95rem;font-weight:800" id="cardPace"></div>
                        </div>
                    </div>
                    <div class="card-corner card-corner-left"></div>
                    <div class="card-corner card-corner-right"></div>
                    <div class="zone-phrase" id="zonePhrase"></div>
                </div>
            </div>
            <div style="text-align:center; margin-top:10px;">
                <button type="button" id="copyCardBtn" style="display:none;">üìã Compartilhar Card</button>
            </div>

        </div>

        <div id="compositor" style="margin-top: 45px; display: none;">
            <h3>Combine com o print do app de corrida:</h3>
            <div class="compose-controls">
                <input type="file" id="composeInput" accept="image/*" class="compose-upload">
                <label id="composeScaleRow" for="composeScale" style="white-space: nowrap; display:none; align-items:center; gap:6px; width:100%;">
                    Tamanho do card:
                    <input type="range" id="composeScale" min="35" max="160" value="100" step="1" style="width:100%;">
                    <span id="composeScaleLabel">100%</span>
                </label>
                <div id="composeActions" style="display:none; gap:8px; width:100%; align-items:stretch;">
                    <button type="button" id="composeExport" class="compose-export" style="flex:1 1 0;" disabled>üíæ Baixar Print</button>
                    <button type="button" id="composeShare" class="compose-export" style="flex:1 1 0;" disabled>üì§ Compartilhar Print</button>
                </div>
            </div>
            <div id="composeWrap" style="position: relative; display: inline-block;">
                <img id="composeImg" alt="" style="max-width: 100%; height: auto; display: none;">
                <div id="composeOverlay" style="position: absolute; inset: 0; pointer-events: auto; visibility: hidden;"></div>
            </div>
        </div>

        <hr style="margin-top: 20px;" />
        <!-- Se√ß√£o: temposRefOrig (inserida) -->
        <div id="tempos-ref-orig" class="tempos-ref-orig tabela-referencia">
            <h2>Metas Top</h2>
            <div id="temposRefOrigContent">
                <table cellpadding="6" cellspacing="0" style="border-collapse: collapse;">
                    <thead>
                        <tr style="background: #eee;">
                            <th>Dist√¢ncia</th>
                            <th>Sexo</th>
                            <th>Idade</th>
                            <th>Tempo</th>
                            <th>Pace / km</th>
                        </tr>
                    </thead>
                    <tbody id="temposRefOrigTbody">
                        <!-- preenchido via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Nova tabela de refer√™ncia por nota -->
        <div class="tabela-notas">
            <h2>Notas (<span id="distancia-ref">2.4</span>km <span id="sexo-ref">Masc.</span> <span
                    id="idade-ref">30</span> anos)</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Nota</th>
                            <th>Tempo</th>
                            <th>Pace</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaNotas">
                        <!-- preenchido via JavaScript -->
                        <!-- Estrutura est√°tica: linhas ser√£o adicionadas dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Nova se√ß√£o de gr√°ficos -->
        <div class="seccion-graficos">
            <h2 id="titulo-graficos">Gr√°ficos: Nota vs Tempo</h2>
            <!-- <p class="muted">Linhas para Homens (M) e Mulheres (F).</p> -->

            <div class="grid-graficos">
                <div class="grafico-wrap">
                    <h4>2.4 km</h4>
                    <canvas id="chart-2-4" width="400" height="250"></canvas>
                </div>

                <div class="grafico-wrap">
                    <h4>5 km</h4>
                    <canvas id="chart-5" width="400" height="250"></canvas>
                </div>

                <div class="grafico-wrap">
                    <h4>10 km</h4>
                    <canvas id="chart-10" width="400" height="250"></canvas>
                </div>

                <div class="grafico-wrap">
                    <h4>15 km</h4>
                    <canvas id="chart-15" width="400" height="250"></canvas>
                </div>

                <div class="grafico-wrap" style="margin-top: 40px; padding-bottom: 50px;">
                    <h4>Meia Maratona</h4>
                    <canvas id="chart-meia" width="400" height="250"></canvas>
                </div>
            </div>
        </div>
        <!-- /Nova se√ß√£o de gr√°ficos -->

        <div class="tabela-referencia">
            <h2>Tempos de Refer√™ncia para Nota 100</h2>
            <div class="table-responsive grid-duas-tabelas">
                <div class="tabela-wrap">
                    <h3>Homens</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Idade</th>
                                <th>2.4km</th>
                                <th>5km</th>
                                <th>10km</th>
                                <th>15km</th>
                                <th>Meia</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaTemposM">
                            <!-- preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="tabela-wrap">
                    <h3>Mulheres</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Idade</th>
                                <th>2.4km</th>
                                <th>5km</th>
                                <th>10km</th>
                                <th>15km</th>
                                <th>Meia</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaTemposF">
                            <!-- preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>



    </div>

    <script src="js/calc.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Biblioteca para capturar o div como imagem -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        const CARD_EXPORT_SCALE = 3;
        const CARD_EXPORT_MIME = 'image/png';
        const CARD_EXPORT_QUALITY = 0.92; // ignorado por alguns navegadores para PNG, mantido por consist√™ncia

        document.getElementById('copyCardBtn').addEventListener('click', async () => {
            const card = document.getElementById('shareCard');
            if (!card || card.style.display === 'none') {
                alert('Nenhum card gerado ainda!');
                return;
            }

            try {
                // Captura o div como imagem
                const canvas = await html2canvas(card, {
                    backgroundColor: null,
                    scale: CARD_EXPORT_SCALE,
                    useCORS: true
                });

                // Monta nome do arquivo
                const distEl = document.getElementById('scoreDistancia');
                let distStr = (distEl && distEl.textContent) ? distEl.textContent.trim() : '';
                distStr = distStr.replace(/\s+/g, '');
                const notaEl = document.getElementById('scoreBig');
                let notaStr = (notaEl && notaEl.textContent) ? notaEl.textContent.trim() : '';
                notaStr = notaStr.replace(/\s+/g, '');
                const now = new Date();
                const dd = String(now.getDate()).padStart(2, '0');
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const yy = String(now.getFullYear()).slice(-2);
                const filename = `igdcc-${notaStr}-${distStr}_${dd}-${mm}-${yy}.png`;

                const blob = await new Promise(resolve => canvas.toBlob(resolve, CARD_EXPORT_MIME, CARD_EXPORT_QUALITY));
                if (!blob) throw new Error('Falha ao gerar imagem');
                const file = new File([blob], filename, { type: CARD_EXPORT_MIME });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'IGDCC',
                        text: 'Meu card do IGDCC'
                    });
                    return;
                }
                if (navigator.share) {
                    const dataUrl = canvas.toDataURL(CARD_EXPORT_MIME, CARD_EXPORT_QUALITY);
                    await navigator.share({
                        title: 'IGDCC',
                        text: 'Meu card do IGDCC',
                        url: dataUrl
                    });
                    return;
                }

                // Fallback: abrir imagem em nova aba para o usu√°rio compartilhar manualmente
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            } catch (err) {
                console.error('Falha ao compartilhar/capturar card:', err);
                alert('Compartilhamento n√£o suportado neste dispositivo/navegador.');
            }
        });
    </script>

    <script src="js/app.js"></script>
</body>

</html>